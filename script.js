const elements={table:document.querySelector("#chapters"),btnFetchPage:document.querySelector("#btnFetchPage")},titleCellIndex=0,statusCellIndex=1,actionCellIndex=2;let storyContents={};const generateId=e=>{let t="",n=e.removeOverWhitespace().split("");for(let e=0;e<n.length;e++)t+=n[e].charCodeAt();return`_${t}`},clearTable=e=>e.querySelectorAll("tbody tr").forEach(e=>e.remove()),listAllItems=e=>{e.forEach((e,t)=>{let n=elements.table.insertRow(elements.table.rows.length),o=e.textContent,r=generateId(o);n.insertCell(0).appendChild(document.createTextNode(o.removeOverWhitespace())),n.insertCell(1).appendChild(document.createTextNode("Downloading..")),n.insertCell(2).appendChild(createButtonDownload(r,`${o.removeOverWhitespace()}`)),n.setAttribute("id",r)})},toggleDisable=e=>e.getAttribute("disabled")?e.removeAttribute("disabled"):e.setAttribute("disabled",!0),download=async(e,t,n)=>{if("pdfFormat"==n){let n=new jsPDF("p","pt","letter"),o=n.splitTextToSize(await new Response(storyContents[e]).text(),180),r=document.createElement("div");r.appendChild(document.createTextNode(o)),document.body.appendChild(r),specialElementHandlers={"#bypassme":function(e,t){return!0}},margins={top:30,bottom:60,left:40,width:522},n.fromHTML(r,margins.left,margins.top,{width:margins.width,elementHandlers:specialElementHandlers},function(e){n.save(`${t}.pdf`)},margins)}else{const n=new Document,o=await new Response(storyContents[e]).text(),r=new Paragraph(o);n.addParagraph(r),(new Packer).toBlob(n).then(e=>saveAs(e,`${t}.docx`))}},createButtonDownload=(e,t)=>{let n=document.createElement("button");return n.appendChild(document.createTextNode("Download")),n.setAttribute("id",e),n.addEventListener("click",()=>{format=document.querySelector("input[type=radio]:checked"),download(e,t,format.getAttribute("id"))}),n},createButtonRetryDownload=(e,t)=>{let n=document.createElement("button");return n.appendChild(document.createTextNode("Download Again")),n.setAttribute("id",e),n.addEventListener("click",()=>{let n=document.createDocumentFragment(),o=document.createElement("a");o.innerHTML=document.querySelector(`#${e}`).children[0].textContent,o.setAttribute("href",t),n.appendChild(o),getEachPageInTableOfContents({table_of_contents:!1,links:n.querySelectorAll("*")})}),n};String.prototype.removeOverWhitespace=function(){return this.trim().replace(/\s+/g," ")};const getPageContent=async e=>{const t=await fetch(e),n=await t.text();let o=(new DOMParser).parseFromString(n,"text/html");const r=null!==o.querySelector(".story-controls");return{content:o.querySelector("pre").textContent.removeOverWhitespace(),table_of_contents:r,links:r?o.querySelectorAll(".table-of-contents > li > a"):[e]}},getEachPageInTableOfContents=e=>{let t=[...e.links],n=0;document.querySelector("#message").innerHTML="";for(let[o,r]of t.entries()){let l=e.table_of_contents?`https://www.wattpad.com${r.getAttribute("href")}`:r,a=generateId(t[o].textContent),c=document.querySelector(`#${a}`).children[1],d=document.querySelector(`#${a}`).children[2];getPageContent(l).then(e=>{n++,c.innerHTML="Ready",c.style.color="green",d.innerHTML="",d.appendChild(createButtonDownload(a,`${t[o].textContent.removeOverWhitespace()}`)),storyContents[a]=new Blob([e.content],{type:"text/plain"})}).then(e=>n===t.length?toggleDisable(elements.btnFetchPage):null).catch(e=>{c.innerHTML="Failed",c.style.color="red",d.innerHTML="",d.appendChild(createButtonRetryDownload(a,"https://www.wattpad.com/470990105-dreadful-vengeance-chapter-2"))})}};document.querySelector("form").addEventListener("submit",e=>{e.preventDefault(),document.querySelector("#message").innerHTML="Please wait...",toggleDisable(elements.btnFetchPage);const t=document.querySelector("#url").value;getPageContent(t).then(e=>{listAllItems(e.links),getEachPageInTableOfContents(e)}).catch(e=>console.log(e))});